<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>

    <!-- Bootstrap 4 -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>


<body class="dashboard-page">
    

    <!-- ======= TOP NAVBAR ======= -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top top-header">
        <a class="navbar-brand" href="#"><i class="fas fa-chart-line"></i> Admin Dashboard</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#sidebarMenu">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="ml-auto">
            <span class="mr-3">Welcome, <strong>{{ username }}</strong></span>
            <a href="/logout" class="btn btn-light btn-sm">Logout</a>
        </div>
    </nav>

    <!-- ======= SIDEBAR ======= -->
    <div class="sidebar collapse show" id="sidebarMenu">
        <h3><i class="fas fa-cogs"></i> Admin</h3>

        <!-- 🔍 Search Bar -->
        <form action="{{ url_for('search') }}" method="GET" class="mb-3 mt-2">
            <div class="input-group">
                <input 
                    type="text" 
                    name="query" 
                    class="form-control form-control-sm" 
                    placeholder="Search by name..." 
                    required>
                <div class="input-group-append">
                    <button class="btn btn-sm btn-primary" type="submit">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
        </form>

        <!-- Sidebar Links -->
        <a href="{{ url_for('dashboard') }}"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
        <a href="#" data-toggle="modal" data-target="#documentsModal"><i class="fas fa-file-alt"></i> Documents</a>
        <a href="#" data-toggle="modal" data-target="#residentsModal"><i class="fas fa-users"></i> Residents</a>
        <a href="#" data-toggle="modal" data-target="#requestsModal"><i class="fas fa-envelope-open-text"></i> Document Requests</a>
        <a href="{{ url_for('records') }}"><i class="fas fa-book"></i> Records</a>
        <a href="/logout" class="logout-link"><i class="fas fa-sign-out-alt"></i> Logout</a>
    </div>

    <!-- ======= MAIN CONTENT ======= -->
    <div class="main-content">
        <div class="container-fluid mt-5 pt-4">

            <!-- Summary Cards -->
            <div class="row">
                <div class="col-md-3 mb-3">
                    <div class="card text-white bg-primary">
                        <div class="card-body">
                            <h5 class="card-title"><i class="fas fa-file-alt"></i> Documents</h5>
                            <h3>{{ documents|length }}</h3>
                            <p>Total Uploaded</p>
                            <button class="btn btn-light btn-sm" data-toggle="modal" data-target="#documentsModal">
                                <i class="fas fa-eye"></i> View
                            </button>
                        </div>
                    </div>
                </div>

                <div class="col-md-3 mb-3">
                    <div class="card text-white bg-success">
                        <div class="card-body">
                            <h5 class="card-title"><i class="fas fa-users"></i> Residents</h5>
                            <h3>{{ residents|length }}</h3>
                            <p>Total Registered</p>
                            <button class="btn btn-light btn-sm" data-toggle="modal" data-target="#residentsModal">
                                <i class="fas fa-eye"></i> View
                            </button>
                        </div>
                    </div>
                </div>

                <div class="col-md-3 mb-3">
                    <div class="card text-white bg-info">
                        <div class="card-body">
                            <h5 class="card-title"><i class="fas fa-envelope-open-text"></i> Requests</h5>
                            <h3>{{ requests|length if requests else 0 }}</h3>
                            <p>Pending Requests</p>
                            <button class="btn btn-light btn-sm" data-toggle="modal" data-target="#requestsModal">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <button class="btn btn-light btn-sm" data-toggle="modal" data-target="#addRequestModal">
                                <i class="fas fa-plus"></i> Add Request
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ✅ Records Card showing total approved certificates -->
                <div class="col-md-3 mb-3">
                    <div class="card text-white bg-danger">
                        <div class="card-body">
                            <h5 class="card-title"><i class="fas fa-book"></i> Records</h5>
                            <h3>{{ approved_count }}</h3>
                            <p>Approved Certificates</p>
                            <a href="{{ url_for('records') }}" class="btn btn-light btn-sm">
                                <i class="fas fa-eye"></i> View Records
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="row">
                <div class="col-md-6">
                    <div class="card mb-4">
                        <div class="card-header"><i class="fas fa-chart-pie"></i> Document Type Distribution</div>
                        <div class="card-body">
                            <canvas id="doughnutChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card mb-4">
                        <div class="card-header"><i class="fas fa-chart-bar"></i> Monthly Report</div>
                        <div class="card-body">
                            <canvas id="barChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ======= DOCUMENTS MODAL ======= -->
    <div class="modal fade" id="documentsModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-file-alt"></i> Barangay Documents</h5>
                    <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                    <table class="table table-striped">
                        <thead class="thead-dark">
                            <tr>
                                <th>ID</th>
                                <th>Document Name</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for doc in documents %}
                            <tr>
                                <td>{{ doc.id }}</td>
                                <td>{{ doc.document_name or doc.document_type }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- ======= RESIDENTS MODAL ======= -->
    <div class="modal fade" id="residentsModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title"><i class="fas fa-users"></i> Registered Residents</h5>
                    <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="mb-3 text-right">
                        <a href="{{ url_for('add_resident') }}" class="btn btn-success">
                            <i class="fas fa-user-plus"></i> Add New Resident
                        </a>
                    </div>

                    <table class="table table-striped">
                        <thead class="thead-dark">
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Address</th>
                                <th>Contact Number</th>
                                <th>Date Registered</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for res in residents %}
                            <tr>
                                <td>{{ res.id }}</td>
                                <td>{{ res.firstname }} {{ res.lastname }}</td>
                                <td>{{ res.address }}</td>
                                <td>{{ res.contact_number }}</td>
                                <td>{{ res.date_registered }}</td>
                                <td>
                                    <a href="{{ url_for('update_resident', resident_id=res.id) }}" class="btn btn-warning btn-sm">
                                        <i class="fas fa-edit"></i> Update
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- ======= DOCUMENT REQUESTS MODAL ======= -->
    <div class="modal fade" id="requestsModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title"><i class="fas fa-envelope-open-text"></i> Document Requests</h5>
                    <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="mb-3 text-right">
                        <button class="btn btn-info" data-toggle="modal" data-target="#addRequestModal">
                            <i class="fas fa-plus"></i> Add New Request
                        </button>
                    </div>

                    <table class="table table-striped">
                        <thead class="thead-dark">
                            <tr>
                                <th>ID</th>
                                <th>Resident Name</th>
                                <th>Document Type</th>
                                <th>Status</th>
                                <th>Request Time</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if requests %}
                                {% for req in requests %}
                                <tr>
                                    <td>{{ req.id }}</td>
                                    <td>{{ req.resident_name }}</td>
                                    <td>{{ req.document_type }}</td>
                                    <td>{{ req.status }}</td>
                                    <td>{{ req.request_time.strftime('%b %d, %Y %H:%M') if req.request_time else 'N/A' }}</td>
                                    <td>
                                        {% if req.status != "Approved" %}
                                            <a href="{{ url_for('accept_request', request_id=req.id) }}" class="btn btn-success btn-sm">
                                                <i class="fas fa-check"></i> Accept
                                            </a>
                                        {% else %}
                                            <button class="btn btn-secondary btn-sm" disabled>Accepted</button>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr><td colspan="6" class="text-center">No requests found.</td></tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- ======= ADD REQUEST MODAL ======= -->
    <div class="modal fade" id="addRequestModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title"><i class="fas fa-plus"></i> Add New Document Request</h5>
                    <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                    <form method="POST" action="{{ url_for('add_request') }}">
                        <div class="form-group">
                            <label>Full Name *</label>
                            <input type="text" name="full_name" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Age *</label>
                            <input type="number" name="age" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Date of Birth *</label>
                            <input type="date" name="dob" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Address *</label>
                            <input type="text" name="address" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Occupation</label>
                            <input type="text" name="occupation" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Document Type *</label>
                            <select name="document_type" class="form-control" required>
                                <option value="" disabled selected>Select Document</option>
                                {% for doc in documents %}
                                    <option value="{{ doc.document_name }}">{{ doc.document_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <button type="submit" class="btn btn-info">Submit Request</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- ======= JS SCRIPTS ======= -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // Doughnut Chart
        var ctxDoughnut = document.getElementById('doughnutChart').getContext('2d');
        new Chart(ctxDoughnut, {
            type: 'doughnut',
            data: {
                labels: {{ chart_labels|tojson }},
                datasets: [{
                    data: {{ chart_values|tojson }},
                    backgroundColor: ['#007bff', '#28a745', '#ffc107', '#dc3545', '#6f42c1', '#fd7e14']
                }]
            },
            options: { responsive: true }
        });

       // ✅ UPDATED Bar Chart (Monthly Report)
        var ctxBar = document.getElementById('barChart').getContext('2d');
        new Chart(ctxBar, {
            type: 'bar',
            data: {
                labels: {{ months|tojson }},
                datasets: [
                    {
                        label: 'Documents',
                        data: {{ doc_counts|tojson }},
                        backgroundColor: '#007bff'
                    },
                    {
                        label: 'Residents',
                        data: {{ res_counts|tojson }},
                        backgroundColor: '#28a745'
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Monthly Report (Active Months Only)',
                        font: { size: 16 }
                    }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    </script>
</body>
</html>
